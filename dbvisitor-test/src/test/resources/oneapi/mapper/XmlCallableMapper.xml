<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//dbvisitor.net//DTD Mapper 1.0//EN"
        "https://www.dbvisitor.net/schema/dbvisitor-mapper.dtd">
<mapper namespace="oneapi.XmlCallableMapper">

    <!-- ========== IN 参数过程调用 ========== -->

    <!-- 1. 纯 IN 参数 — 调用存储过程插入用户 -->
    <execute id="callInsertUser" statementType="CALLABLE">
        call proc_insert_user(#{id}, #{name})
    </execute>

    <!-- ========== INOUT 参数过程调用 ========== -->

    <!-- 2. IN + INOUT — 输入值翻倍返回 -->
    <execute id="callDoubleValue" statementType="CALLABLE" bindOut="p_result">
        call proc_double_value(#{p_input},
                               #{p_result, mode=INOUT, jdbcType=INTEGER})
    </execute>

    <!-- 3. IN + 多个 INOUT — 字符串拼接 + 长度 -->
    <execute id="callMultiInout" statementType="CALLABLE" bindOut="p_concat,p_length">
        call proc_multi_inout(#{p_prefix},
                              #{p_suffix},
                              #{p_concat, mode=INOUT, jdbcType=VARCHAR},
                              #{p_length, mode=INOUT, jdbcType=INTEGER})
    </execute>

    <!-- ========== 输出参数过程调用（PG PROCEDURE 仅支持 INOUT，不支持 OUT） ========== -->

    <!-- 4. 单个输出 — 查询用户总数 -->
    <execute id="callUserCount" statementType="CALLABLE" bindOut="p_count">
        call proc_user_count(#{p_count, mode=INOUT, jdbcType=INTEGER})
    </execute>

    <!-- 5. 多个输出 — 查询聚合统计（count, max_id, min_name） -->
    <execute id="callUserStats" statementType="CALLABLE" bindOut="p_count,p_max_id,p_min_name">
        call proc_user_stats(#{p_count, mode=INOUT, jdbcType=INTEGER},
                             #{p_max_id, mode=INOUT, jdbcType=INTEGER},
                             #{p_min_name, mode=INOUT, jdbcType=VARCHAR})
    </execute>

    <!-- ========== refcursor 结果集返回 ========== -->

    <!-- 6. 单个 refcursor — 返回一个结果集 -->
    <execute id="callQueryUsers" statementType="CALLABLE" bindOut="p_out,res1">
        call proc_query_users(#{p_name, jdbcType=VARCHAR},
                              #{p_out, mode=INOUT, jdbcType=VARCHAR},
                              #{res1, mode=CURSOR})
    </execute>

    <!-- 7. 多个 refcursor — 返回两个结果集 + INOUT 输出 -->
    <execute id="callQueryUsersMulti" statementType="CALLABLE" bindOut="p_out_msg,res_matched,res_unmatched">
        call proc_query_users_multi(#{p_name, jdbcType=VARCHAR},
                                    #{p_out_msg, mode=INOUT, jdbcType=VARCHAR},
                                    #{res_matched, mode=CURSOR},
                                    #{res_unmatched, mode=CURSOR})
    </execute>

    <!-- ========== bindOut 不指定 — 返回全部结果 ========== -->

    <!-- 8. 不设置 bindOut — 返回多结果集的完整 Map (包含 #result-set-N 和 #update-count-N) -->
    <execute id="callQueryUsersNoBind" statementType="CALLABLE">
        call proc_query_users(#{p_name, jdbcType=VARCHAR},
                              #{p_out, mode=INOUT, jdbcType=VARCHAR},
                              #{res1, mode=CURSOR})
    </execute>

</mapper>
