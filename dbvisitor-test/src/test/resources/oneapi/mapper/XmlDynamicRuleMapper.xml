<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//dbvisitor.net//DTD Mapper 1.0//EN"
        "https://www.dbvisitor.net/schema/dbvisitor-mapper.dtd">
<mapper namespace="xmltest.DynamicRuleMapper">

    <resultMap id="userResultMap" type="net.hasor.dbvisitor.test.oneapi.model.UserInfo">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="age" property="age"/>
        <result column="email" property="email"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <insert id="insertUser">
        INSERT INTO user_info (id, name, age, email, create_time)
        VALUES (#{id}, #{name}, #{age}, #{email}, CURRENT_TIMESTAMP)
    </insert>

    <!-- @{and} 单条件测试：参数非空时追加 AND，参数为 null 时自动跳过 -->
    <select id="selectWithAndSingle" resultMap="userResultMap">
        SELECT * FROM user_info
        WHERE name LIKE 'DynRule%'
        @{and, age = :age}
        ORDER BY id
    </select>

    <!-- @{and} 双条件测试：同时提供两个参数 -->
    <select id="selectWithAndDouble" resultMap="userResultMap">
        SELECT * FROM user_info
        WHERE name LIKE 'DynRule%'
        @{and, age = :age}
        @{and, email = :email}
        ORDER BY id
    </select>

    <!-- @{or} 规则 -->
    <select id="selectWithOrRule" resultMap="userResultMap">
        SELECT * FROM user_info
        WHERE name LIKE 'DynRule%'
        AND (1=0
        @{or, age = :age}
        @{or, email = :email}
        )
        ORDER BY id
    </select>

    <!-- @{in} 列表展开 + @{and} 嵌套 -->
    <select id="selectWithInRule" resultMap="userResultMap">
        SELECT * FROM user_info
        WHERE name LIKE 'DynRule%'
        @{and, id IN @{in, :ids}}
        ORDER BY id
    </select>

    <!-- @{and} + <if> + XML 动态标签混合 -->
    <select id="selectMixed" resultMap="userResultMap">
        SELECT * FROM user_info
        WHERE name LIKE 'DynRule%'
        <if test="minAge != null">@{and, age >= :minAge}</if>
        <if test="email != null">
            AND email = #{email}
        </if>
        ORDER BY id
    </select>

    <!-- @{and} 多条件组合（where 1=1 模式） -->
    <select id="selectMultipleAndRules" resultMap="userResultMap">
        SELECT * FROM user_info
        WHERE 1=1
        @{and, name like :name}
        @{and, age >= :minAge}
        @{and, age &lt;= :maxAge}
        ORDER BY id
    </select>

</mapper>
