<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//dbvisitor.net//DTD Mapper 1.0//EN"
        "https://www.dbvisitor.net/schema/dbvisitor-mapper.dtd">
<mapper namespace="xmltest.JoinQueryMapper">

    <resultMap id="userOrderDTOMap" type="net.hasor.dbvisitor.test.model.UserOrderDTO">
        <result column="order_id" property="orderId"/>
        <result column="order_no" property="orderNo"/>
        <result column="amount" property="amount"/>
        <result column="order_create_time" property="createTime"/>
        <result column="user_id" property="userId"/>
        <result column="user_name" property="userName"/>
        <result column="user_email" property="userEmail"/>
    </resultMap>

    <insert id="insertUser">
        INSERT INTO user_info (id, name, age, email, create_time)
        VALUES (#{id}, #{name}, #{age}, #{email}, CURRENT_TIMESTAMP)
    </insert>

    <insert id="insertOrder">
        INSERT INTO user_order (id, user_id, order_no, amount, create_time)
        VALUES (#{id}, #{userId}, #{orderNo}, #{amount}, CURRENT_TIMESTAMP)
    </insert>

    <!-- INNER JOIN：映射到 DTO -->
    <select id="selectUserOrderDTO" resultMap="userOrderDTOMap">
        SELECT
            o.id AS order_id,
            o.order_no AS order_no,
            o.amount AS amount,
            o.create_time AS order_create_time,
            u.id AS user_id,
            u.name AS user_name,
            u.email AS user_email
        FROM user_order o
        INNER JOIN user_info u ON o.user_id = u.id
        WHERE u.id = #{userId}
        ORDER BY o.id
    </select>

    <!-- INNER JOIN：映射到 Map -->
    <select id="selectUserOrderMap" resultType="map">
        SELECT
            o.id AS order_id,
            o.order_no,
            o.amount,
            u.id AS user_id,
            u.name AS user_name,
            u.email AS user_email
        FROM user_order o
        INNER JOIN user_info u ON o.user_id = u.id
        WHERE u.id = #{userId}
        ORDER BY o.id
    </select>

    <!-- LEFT JOIN：无匹配行时 null 处理 -->
    <select id="selectUserOrderLeftJoin" resultType="map">
        SELECT
            u.id AS user_id,
            u.name AS user_name,
            o.id AS order_id,
            o.order_no
        FROM user_info u
        LEFT JOIN user_order o ON u.id = o.user_id
        WHERE u.id = #{userId}
    </select>

    <!-- 聚合函数 + GROUP BY -->
    <select id="selectUserOrderAggregate" resultType="map">
        SELECT
            u.id AS user_id,
            u.name AS user_name,
            COUNT(o.id) AS order_count,
            COALESCE(SUM(o.amount), 0) AS total_amount
        FROM user_info u
        LEFT JOIN user_order o ON u.id = o.user_id
        WHERE u.id = #{userId}
        GROUP BY u.id, u.name
    </select>

    <!-- 自连接 -->
    <select id="selectSameAgeUsers" resultType="map">
        SELECT
            u1.id AS user1_id,
            u1.name AS user1_name,
            u2.id AS user2_id,
            u2.name AS user2_name,
            u1.age AS common_age
        FROM user_info u1
        INNER JOIN user_info u2 ON u1.age = u2.age AND u1.id &lt; u2.id
        WHERE u1.name LIKE 'JoinQ%' AND u2.name LIKE 'JoinQ%'
        ORDER BY u1.age, u1.id
    </select>

    <!-- 子查询 -->
    <select id="selectUsersWithOrders" resultType="net.hasor.dbvisitor.test.model.UserInfo">
        SELECT * FROM user_info
        WHERE id IN (
            SELECT DISTINCT user_id FROM user_order
        )
        AND name LIKE 'JoinQ%'
        ORDER BY id
    </select>

</mapper>
